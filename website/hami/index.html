<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title>CloudCam</title>

    <!-- Favicon -->
    <link rel="icon" href="./img/rpi-img/camera_tran.png">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="style.css">

    <style>
        html {
            scroll-behavior: smooth;
        }
    </style>

</head>

<body>
    <!-- Preloader -->
    <div id="preloader">
        <div class="loader"></div>
    </div>
    <!-- /Preloader -->

    <!-- Header Area Start -->
    <header class="header-area">
        <!-- Top Header Area Start -->

        <!-- Top Header Area End -->

        <!-- Main Header Start -->
        <div class="main-header-area">
            <div class="classy-nav-container breakpoint-off">
                <div class="container">
                    <!-- Classy Menu -->
                    <nav class="classy-navbar justify-content-between" id="hamiNav">

                        <!-- Logo -->
                        <!-- <a class="nav-brand" href="index.html"><img src="./img/core-img/logo.png" alt=""></a> -->
                        <a class="nav-brand" href="index.html">
                            <h1 style="color:white">ECE 5725 Final Project</h1>
                        </a>

                        <!-- Navbar Toggler -->
                        <div class="classy-navbar-toggler">
                            <span class="navbarToggler"><span></span><span></span><span></span></span>
                        </div>

                        <!-- Menu -->
                        <div class="classy-menu">
                            <!-- Menu Close Button -->
                            <div class="classycloseIcon">
                                <div class="cross-wrap"><span class="top"></span><span class="bottom"></span></div>
                            </div>
                            <!-- Nav Start -->
                            <div class="classynav">
                                <ul id="nav">
                                    <li><a href="#Intro">Intro</a></li>
                                    <li><a href="#System Overview">Overview</a></li>
                                    <li><a href="#Implementation">Implementation</a>
                                        <ul class="dropdown">
                                            <li><a href="#Setup">RPi Setup</a></li>
                                            <li><a href="#Control">Control System</a></li>
                                            <li><a href="#Effects">Image Effects</a></li>
                                            <li><a href="#Cloud">Cloud Connection</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#Conclusion">Conclusion</a></li>
                                    <li><a href="#Appendix">Appendix</a></li>
                                </ul>

                                <!-- Live Chat -->

                            </div>
                            <!-- Nav End -->
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </header>
    <!-- Header Area End -->

    <!-- Welcome Area Start -->
    <section class="welcome-area">

        <!-- Welcome Pattern -->
        <div class="welcome-pattern">
            <img src="img/core-img/welcome-pattern.png" alt="">
        </div>

        <!-- Welcome Slide -->
        <div class="welcome-slides owl-carousel">

            <!-- Single Welcome Slide -->
            <div class="single-welcome-slide">
                <!-- Welcome Content -->
                <div class="welcome-content h-100">
                    <div class="container h-100">
                        <div class="row h-100 align-items-center">
                            <!-- Welcome Text -->
                            <div class="col-12 col-md-9 col-lg-7">
                                <div class="welcome-text mb-50">
                                    <h2 data-animation="fadeInLeftBig" data-delay="200ms" data-duration="1s">
                                        CloudCam
                                    </h2>
                                    <h3 data-animation="fadeInLeftBig" data-delay="400ms" data-duration="1s">
                                        Cloud-Connected Special Effects Camera for Raspberry Pi
                                    </h3>
                                    <p data-animation="fadeInLeftBig" data-delay="600ms" data-duration="1s">
                                        Anirudh Maddula(aam252), Laasya Renganathan (lpr46)
                                        <br>
                                        5/21/20
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Welcome Thumbnail -->
                <div class="welcome-thumbnail">
                    <img src="img/bg-img/1.png" alt="">
                </div>
            </div>

            <!-- Single Welcome Slide -->
            <div class="single-welcome-slide">
                <!-- Welcome Content -->
                <div class="welcome-content h-100">
                    <div class="container h-100">
                        <div class="row h-100 align-items-center">
                            <!-- Welcome Text -->
                            <div class="col-12 col-md-9 col-lg-7">
                                <div class="welcome-text mb-50">
                                    <h2 data-animation="fadeInLeftBig" data-delay="200ms" data-duration="1s">
                                        CloudCam
                                    </h2>
                                    <h3 data-animation="fadeInLeftBig" data-delay="400ms" data-duration="1s">
                                        Cloud-Connected Special Effects Camera for Raspberry Pi
                                    </h3>
                                    <p data-animation="fadeInLeftBig" data-delay="600ms" data-duration="1s">
                                        Anirudh Maddula(aam252), Laasya Renganathan (lpr46)
                                        <br>
                                        5/21/20
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Welcome Thumbnail -->
                <div class="welcome-thumbnail">
                    <img src="img/bg-img/2.png" alt="">
                </div>
            </div>


        </div>

        <!-- Clouds -->
        <div class="clouds">
            <img src="img/core-img/cloud-1.png" alt="" class="cloud-1">
            <img src="img/core-img/cloud-2.png" alt="" class="cloud-2">
            <img src="img/core-img/cloud-3.png" alt="" class="cloud-3">
            <img src="img/core-img/cloud-4.png" alt="" class="cloud-4">
            <img src="img/core-img/cloud-5.png" alt="" class="cloud-5">
        </div>
    </section>
    <!-- Welcome Area End -->

    <!-- Find Domain Area Start -->
    <section id="Intro" class="find-domain-area section-padding-100-0">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-12 col-md-4">
                    <div class="domain-text mb-100">
                        <h1 style="font-size: 60px;">Introduction</h1>
                        <div class="mb-15">
                            <img class="rounded mx-auto d-block" src="img/rpi-img/picam.jpg" alt="picam">
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-8">
                    <div class="domain-text mb-100">
                        <h5>Image processing tasks are used everywhere in modern technology, from graphics engines to
                            iPhone apps and biomedical imaging applications. This objective of this project is to bring
                            a greater
                            understanding to all flavors of image processing tasks by surveying them through the RPi
                            CloudCam, our digital effects camera.</h5>
                        <h5>CloudCam is a cloud-connected camera capable of capturing and customizing images with a
                            slew of digital effects computed on board a Raspberry Pi 3. Users can also run Machine
                            Learning model predictions on captured photos through CloudCam’s Amazon Web Services
                            Elastic Compute Cloud (AWS EC2) interface to detect human emotions or common objects.
                            Finally,
                            all captured shots can be optionally saved locally and/or uploaded to a remote AWS
                            Simple Storage Service (S3)
                            server for later use!</h5>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Find Domain Area End -->

    <!-- Features Area Start -->
    <section id="System Overview" class="hami-features-area bg-gray section-padding-100">
        <div class="container">
            <div class="row">
                <!-- Section Heading -->
                <div class="col-12">
                    <div class="section-heading text-center">
                        <h2>System Overview</h2>
                        <p>A high-level design of the project.</p>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="blog-details-text">
                        <p>CloudCam is a system of hardware, local software, and remote software coming together in a
                            state machine. An overall diagram depicting the inputs, flows, and data sources for each of
                            the four major states is shown in the system diagram below:</p>

                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row justify-content-center mb-15">
                    <div>
                        <img src="img/rpi-img/state0.png" alt="state0"></div>
                    <div>
                        <img src="img/rpi-img/state1.png" alt="state1"></div>
                </div>
                <div class="row justify-content-center mb-15">
                    <div>
                        <img src="img/rpi-img/state2.png" alt="state2"></div>
                    <div>
                        <img src="img/rpi-img/state3.png" alt="state3"></div>
                </div>
            </div>
            <div class="row justify-content-center mb-30">
                <div class="col-12">
                    <div class="blog-details-text">
                        <p>The first three GPIO-connected physical buttons on a PiTFT screen control the transition
                            between states, and the fourth button quits the camera application. The touchscreen is used
                            to control actions in the menu state, which will trigger the display of the digital effects.
                            Some of the menu options, particularly in the ML menu and Upload menu, will trigger calls to
                            the various Cloud resources the CloudCam is connected to. We further break down the
                            implementation
                            details of each component of CloudCam in the Implementation section.</p>

                    </div>
                </div>
            </div>

        </div>

        <!-- Feature Pattern -->
        <div class="feature-pattern">
            <img src="img/core-img/welcome-pattern.png" alt="">
        </div>
    </section>
    <!-- Features Area End -->

    <!-- Price Plan Area Start -->
    <section id="Implementation" class="hami-price-plan-area mt-50">
        <div class="container">
            <div class="row">
                <!-- Section Heading -->
                <div class="col-12">
                    <div class="section-heading text-center">
                        <h2>Implementation</h2>
                        <p>The building blocks of the project</p>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">

                <!-- Setup -->
                <div id="Setup" class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Basic Raspberry Pi Setup</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <p>While most of this project is implemented in software, the camera hardware setup is
                                critical to CloudCam’s success (naturally). In order to properly configure a camera with
                                the Raspberry Pi, we followed <a
                                    href="https://projects.raspberrypi.org/en/projects/getting-started-with-picamera/2">[this]</a>
                                setup tutorial. The physical camera connection looks like this:</p>
                            <div class="container">
                                <div class="row justify-content-center mb-15">
                                    <div class="col-6">
                                        <img src="img/rpi-img/rpi_camera.png" alt="rpi_camera"></div>
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/frontcam.jpg" alt="frontcam"></div>
                                </div>
                            </div>
                            <p>Once we ensured that physical connection was secure, we opened up the
                                <code>raspi-config</code> tool, and clicked on the interfaces tab. In order to connect
                                to the camera, the ‘camera’ and ‘I2C’ options needed to be enabled. We made these
                                changes, rebooted the Pi, and used the <code>raspistill -o test.jpg</code> test command
                                to make sure the camera worked. The images initially came out blurry, so we used a focus
                                ring to adjust the camera lens. After successfully creating the test.jpg file, we were
                                ready to get started on the actual CloudCam code!

                            </p>
                        </div>
                    </div>
                </div>

                <!-- Control System -->
                <div id="Control" class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Control System</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <p>As described in the HLD section, CloudCam operates through a state machine of four
                                specific states, as controlled by the user’s button and touchscreen presses. For the
                                menu handler state specifically, we divide our code into a variety of different
                                functions, which have one of four categories: image processing functions that actually
                                perform computations, “blit” functions that manage display, “handler” functions that
                                monitor and respond to user input, and “miscellaneous” functions that handle other
                                CloudCam tasks, such as Given this, a typical flow of a user’s inputs would look
                                something like this.
                            </p>

                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/statemachine.png"
                                    alt="statemachine">
                            </div>

                            <p>Essentially, a user can take as many photos as they want, until the program is exited.
                                For each photo they take, they can customize that photo with over a dozen different
                                digital effects that can be compounded to create stimulating, artistic photos. Or, they
                                could choose to use their image as an input to a Machine Learning service, and view
                                those results any number of times. Once they are satisfied with the end result of their
                                customizations, a user is easily able to open up a Save/Upload menu, where they can
                                choose to discard an image, save it locally, or upload it to the Cloud.
                            </p>
                            <p>
                                Once the image effects menu is opened, a “level 1” menu is displayed, which divides up
                                the different effects into four categories. </p>

                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" style="width:35%; height:35%"
                                    src="img/rpi-img/menu1.jpg" alt="menu1">
                            </div>

                            <p>Clicking on any of these category options will open one of the following four “level 2”
                                menus, which will allow a user to select the specific end effects they would like to
                                apply to the image. Examples of the level 1 to level 2 menu transition are displayed
                                below.</p>

                            <div class="container" style="width:75%; height:75%">
                                <div class="row justify-content-center mb-15">
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/menu2.jpg" alt="menu2"></div>
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/menu3.jpg" alt="menu3"></div>
                                </div>
                                <div class="row justify-content-center mb-15">
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/menu4.jpg" alt="menu4"></div>
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/menu5.jpg" alt="menu5"
                                            style="width:100%; height:97%"></div>
                                </div>
                            </div>

                            <p>The menu handlers for the image effects are handled entirely by touchscreen input. The
                                quadrant of the screen press is recorded, and mapped into the next menu transition. This
                                also applies to the Save/Upload menu transitions, which occur when transitioning back to
                                the free view mode, and display the following screens:</p>

                            <div class="container" style="width:75%; height:75%">
                                <div class="row justify-content-center mb-15">
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/save1.jpg" alt="save1"></div>
                                    <div class="col-6">
                                        <img class="rounded" src="img/rpi-img/save2.jpg" alt="save2"></div>
                                </div>
                            </div>

                            <p>The next few sections will deep dive into how the different image effects were
                                implemented, and how the cloud connection component of this project actually works!</p>
                        </div>
                    </div>
                </div>

                <!-- Image Effects -->
                <div id="Effects" class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Image Effects</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <p>For this project, we implemented a wide variety of fun image effects that a user can
                                choose from when using the CloudCam. Many of these effects were created using the
                                highly-optimized image processing Python library, OpenCV. The next few sections will go
                                in-depth into how each of the grouped image applications are actually implemented.</p>

                            <h3><u>Filters</u></h3>
                            <p>The filtering effects are grouped as such because the effects in this category mimic the
                                iPhone or Instagram style filters. Much of the following work was adapted from <a
                                    href="https://towardsdatascience.com/python-opencv-building-instagram-like-image-filters-5c482c1c5079">[this]</a>.
                                These typically involve an application of a 2D filter on an image, or involve changing
                                the values in the different RGB channels of the image.</p>

                            <h4>Noir</h4>

                            <p>The simplest of the filtering-type applications, this effect uses the <code>cv2.cvtColor(im,
                                cv2.BGR2GRAY)</code> to convert an image to grayscale while preserving lumosity. As the
                                image
                                loses two channels (going from BGR to gray), we have to account for the transition from
                                3D numpy arrays to 2D when displaying our image to the screen.</p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/noir.jpg"
                                    alt="noir">
                            </div>
                            <h4>Sepia</h4>

                            <p>Sepia is a sample image filter that gives an image an “aged photograph” look. It is
                                computed by applying the following filter to an input image.</p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/sepia.png" alt="sepia">
                            </div>
                            <h4>Warm and Cool Images</h4>
                            <p>“Warm” and “cool” are offered as two separate effect options, but they simply involve
                                adjusting the distributions of the red and blue RGB channels respectively. Warmer images
                                appear “redder” while cooler images appear “bluer.” The channels were adjusted through a
                                <code>spreadLookupTable()</code> function that adjusted the values according to a
                                Univariate Spline
                                transform. </p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/warm.jpg"
                                        alt="warm"></div>
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/cold.jpg"
                                        alt="cold"></div>
                            </div>

                            <h3><u>Adjustments</u></h3>
                            <p>The adjustment group of image effects include four effects that can be dynamically
                                incremented or decremented in an image. Common effects of this type include contrast and
                                brightness adjustment, blur and sharpness, and saturation.
                                <br>
                                Choosing an effect in the adjustment menu will open up the current status of the edited
                                image along with an adjustment bar at the bottom, as shown below. </p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" style="width:35%; height:35%"
                                    src="img/rpi-img/incr.jpg" alt="incr">
                            </div>
                            <p>That bar serves as essentially a “level 2.5” menu option, as the system isn’t officially
                                at the “view edited image state” until the “done” option is pressed. The “+” and “-”
                                options will respectively trigger the increase and decrease modes on whichever
                                adjustment function (e.g. increase contrast) is selected from the level 2 menu, and
                                apply them to the edited image. The resulting image is displayed on the screen to be
                                previewed, until the edits are finalized by selecting “done.”</p>

                            <h4>Contrast and Brightness</h4>
                            <p>Although these are implemented as two separate effects in the menu, they both are similar
                                in that they involve linear operations of the form aX + b where X is the input image.
                                The a parameter adjusts the contrast value multiplicatively, while the b parameter
                                adjusts the brightness parammer additively. Brightness refers to the overall lightness
                                or darkness of the image, so increasing the brightness every pixel in the frame gets
                                lighter because of the constant bias. Contrast is the difference in brightness between
                                objects in the image. Increasing the contrast of an image makes light areas lighter and
                                dark areas darker. High and Low contrast images are shown below:</p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/bright.jpg"
                                        alt="bright"></div>
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/dark.jpg"
                                        alt="dark"></div>
                            </div>
                            <p>Contrast and brightness adjustment are respectively implemented by adjusting the alpha
                                and beta parameters in the OpenCV function
                                <code>cv2.convertScaleAbs(alpha=a, beta=b)</code>, which
                                performs the linear transform. For contrast adjustment on the user end, pressing the +
                                button sets the contrast to 0.9, and the - button sets it to 1.1, and the images are
                                multiplied by these constants. When the + button is selected for brightness adjustment,
                                beta is set to +1, incrementing the overall image brightness by skewing it to the max
                                brightness level. Similarly, if the - is pressed, beta is set to -1 to shift the image
                                pixels down by one constant. High and Low brightness images are shown below: </p>

                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block"
                                        src="img/rpi-img/image_effects/high_contrast.jpg" alt="high_contrast"></div>
                                <div>
                                    <img class="rounded mx-auto d-block"
                                        src="img/rpi-img/image_effects/low_constrast.jpg" alt="low_constrast"></div>
                            </div>
                            <h4>Blur and Sharpness</h4>
                            <p>The blur and sharpness adjustment effects are condensed into just one “blur” option,
                                which involves the repeated application of either a blur or sharpness kernel, depending
                                on a user’s input. If the + button is pressed, the image is filtered with a blur filter,
                                like the one below.</p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/blur1.png" alt="blur1"></div>
                            </div>
                            <p>This is the equivalent of an averaging, or box filter. By contrast, if “-” is pressed, a
                                sharpness kernel is applied, such as the one below:</p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/blur2.png" alt="blur2"></div>
                            </div>

                            <p> The result of blurring is exactly what it sounds like; the image
                                looks fuzzier with details obscured. The result of the sharpening kernel is an image
                                with enhanced edges and vibrant colors - almost like a colored-pencil sketch.
                            </p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/blur.jpg"
                                        alt="Blur"></div>
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/sharp.jpg"
                                        alt="sharp"></div>
                            </div>
                            <h4>Saturation</h4>

                            <p>The final adjustment parameter is the saturation adjustment. As stated earlier, OpenCV
                                stores images in BGR format, and we are used to seeing images in RGB format as well.
                                Adjusting the saturation required converting the image to an HSV type - Hue, Saturation,
                                Value. Hue represents the color portion of a pixel as a number from 0 to 360 degrees:
                                Saturation describes the amount of gray in a particular color, from 0 to 100 percent.
                                Reducing this component toward zero introduces more gray into the image and produces a
                                faded effect. By contrast, saturated images seem vibrant, with fuller colors. Sometimes,
                                saturation appears as a range from 0 to 1, where 0 is gray, and 1 is a primary color.
                                Value works in conjunction with saturation and describes the brightness or intensity of
                                the color, from 0 to 100 percent, where 0 is completely black, and 100 is the brightest
                                and reveals the most color. To adjust saturation, we converted the image to HSV through
                                the <code>cv2.cvtColor(img, cv2.COLOR_BGR2HSV)</code> and split the resulting channels
                                into h, s, and
                                v components. We then added a constant value of 5 to all values in the image’s s
                                channel, if the + button was pressed, or subtracted 5 if the - button was pressed.
                            </p>
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/high_sat.jpg"
                                        alt="high_sat"></div>
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/low_sat.jpg"
                                        alt="low_sat"></div>
                            </div>

                            <h3><u>Special Effects and Restoring</u></h3>
                            <p>Special image effects that we included are ones that did not full under the filtering or
                                adjusting umbrellas, but can be added to an image for other cool effects. In particular,
                                we have support for 8-bit style images through pixelation, poster-like images through
                                color clustering, and image outlines through Canny edge detection.

                                As mentioned previously, these image effects can be stacked up on top of each other and
                                used in conjunction. If a user wants to “clear out” these image effects and restore to
                                defaults, that option is provided in this menu as well by pressing the “restore” button.
                            </p>
                            <h4>Pixelation</h4>

                            <p>By “pixelating” an image, we can cool images in the style of an 8-bit video game. The
                                pixelation process is a relatively simple matter of rescaling, using different
                                interpolation methods. Interpolation is essentially the process of “guessing” what a
                                neighboring pixel would be. To implement pixelation, we first downscale the image using
                                <code>cv2.resize(img, cv2.INTERP_LINEAR)</code>. The linear interpolator will use a
                                combination of
                                linear functions in order to determine neighboring pixels accurately. We then rescale
                                the image back up using <code>cv2.resize(img, cv2.INTERP_NEAREST)</code>.
                                Nearest-neighbors
                                interpolation does not adjust values of the pixels; it determines the neighboring pixels
                                based on the exact values of pixels already present. This creates “blocks” in the
                                rescaled image, mimicking pixels of an 8-bit game!</p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/pixel.jpg"
                                    alt="pixel">
                            </div>
                            <h4>Color Clustering</h4>
                            <p>Another special effect we added was color clustering through K means. Color clustering,
                                or color quantization is the process of reducing the number of colors in an image. One
                                reason to do so is to reduce the memory, but another reason, as in our case, is for the
                                cool comic-book style poster effect. We use the OpenCV implementation of the K-means
                                clustering algorithm for color quantization. K-means is an algorithm that attempts to
                                classify an unknown set of data, in this case a bunch of RGB pixels, into a set number
                                of groups or clusters. In an image, there are 3 features, R,G,B. To run this, we need to
                                reshape the image to an array of Mx3 size, where M is the number of pixels in an image.
                                After the clustering, we apply centroid values to all pixels, such that the resulting
                                image will have the specified number of colors.
                            </p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/poster.jpg"
                                    alt="poster">
                            </div>

                            <h4>Canny Edge Images</h4>
                            <p>The final special effect CloudCam has is the ability to generate edge images, resembling
                                outlines. We accomplish this by using <code>cv2.Canny(img)</code>, which performs the
                                Canny edge
                                detection algorithm. That algorithm utilizes a series of gradient calculations, as well
                                as a hysteresis double-threshold, in order to compute “strong” edges of an image.
                                Although these thresholds need to be fine-tuned on a per-image basis in order to have
                                the optimal results, for a typical image the standard lower/upper thresholds of 100 and
                                200 produce meaningful results!</p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/canny.jpg"
                                    alt="canny">
                            </div>
                            <h3><u>Stacking image effects</u></h3>
                            <p>A feature of the CloudCam is that these image effects can stack up on top of each other
                                to
                                create new, unique image effects. These can be from any non-ML category. For example, a
                                user
                                could apply a warm filter, adjust the saturation, adjust the contrast, run a color
                                clustering,
                                and then pixelate an image - or any sort of combination like that, with no limit. The
                                results of
                                that particular sequence is shown below:
                            </p>
                            <div class="mb-15">
                                <img class="rounded mx-auto d-block" src="img/rpi-img/image_effects/combo.jpg"
                                    alt="comboo">
                            </div>

                            <h3><u>Machine Learning</u></h3>
                            <p>The image effects described above are examples of classical, or non-learning-based
                                Computer Vision applications. Most of these require relatively simple calculations, and
                                run nearly instantly on the RPi. However, the newer applications of Computer Vision are
                                typically done in conjunction with Machine Learning (ML) applications. Hundreds of
                                different ML models exist that can generate or extract meaningful data from an input
                                image, for a variety of different purposes. A camera that can generate inference results
                                for trained ML models on the fly will certainly be a useful tool. To demonstrate our
                                CloudCam’s ability to do so, we utilize two robust, pre-trained ML model frameworks,
                                mini-Xception for Face and Emotion Recognition and MaskRCNN for common object detection
                                and instance segmentation, as connections to the CloudCam.
                            </p>
                            <p>
                                To clarify, we don’t take credit for any of the ML models themselves - we borrowed
                                pretrained versions of them. You can find the MaskRCNN model here on
                                <a
                                    href="https://gluon-cv.mxnet.io/build/examples_instance/demo_mask_rcnn.html">[<code>gluon</code>]</a>
                                and the face and emotion classification network here on <a
                                    href="https://github.com/oarriaga/face_classification">[github]</a>.
                                These resources provide more in-depth information on the implementation and usage of
                                these model architectures.
                            </p>
                            <p>
                                Examples of Emotion Recognition and MaskRCNN predictions are shown below:
                            </p>
                            <h4>Emotion Detection Results</h4>
                            <div class="container">
                                <div class="row justify-content-center mb-15">
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/happy_woman.jpg" alt="happy_woman"></div>
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/sad_man.jpg" alt="sad_man"></div>
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/neutral_woman.jpg" alt="neutral_woman">
                                    </div>
                                </div>
                            </div>
                            <h4>MaskRCNN Results</h4>
                            <div class="container">
                                <div class="row justify-content-center mb-15">
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/mask2.jpg" alt="mask2"></div>
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/mask3.jpg" alt="mask3"></div>
                                    <div class="col-4">
                                        <img class="rounded" src="img/rpi-img/objects.jpg" alt="objects"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cloud Connection -->
                <div id="Cloud" class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Cloud Connection</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <h3>AWS EC2/S3 Infrastructure</h3>
                            <p>We wanted to run larger, compute-heavy machine learning models on the images, but the
                                hardware that comes in with the Pi has CPU, RAM, and memory limitations. It is also not
                                realistic to scale the project on the Pi if we wanted to add more classification options
                                and models. Thus, we turned to an AWS (Amazon Web Services) infrastructure to support
                                this computation using their
                                cloud technologies. </p>
                            <p>
                                Specifically, we used Amazon EC2 (Elastic Compute Cloud) and Amazon S3 (Simple Storage
                                Service). EC2 provides virtual compute environments (instances )that you can customize
                                and configure, where adding more resources to the instance will cost more. S3 provides
                                cloud storage containers (called buckets) where you can store data (in our case,
                                images).</p>
                            <p>
                                We used EC2 to load a t2.medium instance with Ubuntu 18.04. The name T2 refers to the
                                type, while the size indicates the amount of RAM. T2 is one of the lowest tier types of
                                instances with minimum CPU compute power. </p>
                            <p>
                                The general pipelines to access the server is explained above. Essentially, we use
                                Nginx, a web server, Gunicorn, as WSGI (Web Server Gateway Interface) server and Flask,
                                a web framework (for python). Nginx handles where requests from the internet arrive
                                first. Gunicorn translates requests into a format the web application can handle. You
                                can learn more about what they do <a
                                    href="https://vsupalov.com/gunicorn-and-nginx/">[here]</a>, and
                                <a
                                    href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-18-04?fbclid=IwAR3DyOy-VuA83ccpaB4jJgcAFkIZGFCDzFuVgSzKwKEpiS_CtN_fL5Xh9v0">[here]</a>
                                are instructions for building your own web server.

                            </p>
                            <p>
                                Start by creating an EC2 instance, ssh in, and follow the instructions!
                                Flask controls the server logic, such as what to do when certain endpoints are called.
                                An endpoint is the URL that the server is waiting to receive and can act on, in our case
                                we have 2 endpoints for each of the models: url/mask/<image_str> and url/emotion/
                                    <image_str>. We have Python functions that are executed when either of these
                                        endpoints are hit (we pass the image through model inference). In addition,
                                        Flask is a RESTful web framework, which means it only takes requests such as GET
                                        and POST. Thus, you must make GET requests to our endpoints. The
                                        server is setup with AWS credentials (private and public key) so that it can
                                        make requests to S3 to upload and
                                        download images using the boto3 api.
                            </p>

                            <h3 class="mt-30">Failed Architectures</h3>
                            <p>We had to make major design changes as we approached a cloud solution. We will make note
                                of failed architectures here for future readers.
                            </p>

                            <h5>AWS IoT Greengrass</h5>
                            <p>
                                First, we tried to use AWS IoT Greengrass. The name sounds useful right? However, it
                                turns how this service is meant for controlling edge devices from a central server… not
                                the other way around. AWS provides something called Greengrass Connectors, which help
                                configure an edge device (the Pi) to do computing ON the device itself, and then send it
                                to the server. This is meaningful when you have multiple edge devices, and want to
                                control all of them through a Greengrass Group. However, the way even Greengrass sends
                                information back and forth between an edge device and the central server is no different
                                than the way we used boto3. Our goal is to not have to run on the Pi, so we looked at
                                other solutions.
                            </p>

                            <h5>AWS Lambda </h5>
                            <p>
                                Second, we tried to use AWS Lambda. Lambda is AWS’s notion of serverless architecture. A
                                Lambda function will wait in the cloud until it is specifically called, execute its
                                contents and exit. There is no server allocated for the function. This allows AWS to
                                manage all resource allocation for all Lambda functions themselves. We figured we would
                                set up Lambda functions that would run the model through an image when specifically
                                called on. This is a valid architecture; however, there is one major limitation. When
                                you deploy a Lambda, you create what is called a deployment package that contains all
                                the files and dependencies for the Lambda. The maximum unzipped file size of a Lambda is
                                250 MB (that is, stored on S3 or Lambda Layers, the maximum size to upload directly to
                                Lambda is only 50 MB). The deployment package of MaskRCNN is 400 MB, which was too much,
                                mostly because of SciPy being too large. As such, Lambda could not handle our needs, and
                                we had to settle on a server-based architecture. If your deployment package is small
                                enough for Lambda to handle, we highly recommend using it as it erases the need to
                                configure an EC2 instance. A regular TensorFlow model can usually stay within the
                                constraints.
                            </p>
                            <h5>EC2 Issues</h5>
                            <p>
                                Finally, we decided to use an EC2 server with Nginx and Flask. Configuring the
                                environment is tedious but doable, just make sure to use a virtual environment. You can
                                find instructions <a
                                    href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-18-04?fbclid=IwAR3DyOy-VuA83ccpaB4jJgcAFkIZGFCDzFuVgSzKwKEpiS_CtN_fL5Xh9v0">[here]</a>.
                            </p>
                            <p>
                                One issue we came across was that the MaskRCNN model kept crashing on the instance due
                                to a memory error. We originally started with a t2.micro instance, part of the free
                                tier, which only has 1 GB of RAM! However, once we upgraded it to a paid instance, a
                                t2.medium with 4 GB of RAM, the model ran fine.
                            </p>
                            <p>
                                MaskRCNN takes about 100 seconds to run on a t2.medium, which has the bare minimum of
                                resources. EC2 has many options for high compute power instances, such as those with
                                GPU’s, but of course these will cost more. However, it keeps the application flexible to
                                by allowing us to run as much computation as we need to simply by throwing money at it.
                                Note that pricing is by the hour, so it is very feasible to downgrade your instance for
                                development and upgrade it for fast performance when needed. This allows for a very
                                scalable architecture depending on how your requirements change! For pricing reference,
                                it costs 4 cents/hr to run the t2.medium, 16 cents/hr to run a t2.xlarge, and 53
                                cents/hr to run a g4dn.xlarge. You can view pricing <a
                                    href="https://aws.amazon.com/ec2/pricing/on-demand/">[here]</a>.
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <!-- Price Plan Area End -->

    <!-- Call To Action Area Start -->
    <!-- Features Area Start -->
    <section id="Conclusion" class="hami-features-area bg-gray section-padding-100">
        <div class="container justify-content-center">
            <div class="row">
                <!-- Section Heading -->
                <div class="col-12">
                    <div class="section-heading text-center">
                        <h2>Results and Conclusions</h2>
                    </div>
                </div>
            </div>

            <div class="row ">
                <div class="col-12">
                    <div class="blog-details-text">
                        <h2 class="mb-4">Results</h2>
                        <p>Everything worked as expected! </p>
                        <p>
                            We were successfully able to demonstrate interfacing with the camera, Raspberry Pi, and the
                            AWS server in a functional state machine.
                            We could view the effects of a variety of image filters, and successfully used the camera
                            input as testing data for two pretrained models hosted on the AWS servers.
                            All pictures that were captured could be saved locally, as well as exported to the S3 bucket
                            successfully.
                            You can view our demo below of all of these features below, on the ECE 5725 Youtube Channel!
                            In addition, all of our code is available at <a
                                href="https://github.com/laasya98/raspi-smart-camera">
                                [this]</a> Github repository!</p>
                        <div class="embed-responsive embed-responsive-16by9">
                            <iframe class="embed-responsive-item" src="https://www.youtube.com/watch?v=Pw1yKnI6G3A"
                                allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h2 class="mb-4">Project Conclusions and Future Work</h2>
                        <p>We had a lot of fun building this project, and were very happy that everything worked out in
                            the end!
                            However, like all great projects, there's plenty of room for improvement and extensions.
                            Here are things we could improve on:</p>

                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h4>Async</h4>
                        <p>One of the issues with basic GET requests is that in python you are calling it like any other
                            function, and need to wait for the function to execute before you can move on in the code.
                            This became a problem with MaskRCNN, which takes about 100 seconds to execute and causes the
                            Pi to hang while we are waiting for a response from the server. It would be very useful to
                            implement asynchronous requests such that the model inference can start as soon as we take a
                            picture, so we can browse other camera options while we wait for the model to finish
                            running.</p>

                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h4>Supporting videos</h4>
                        <p>The scope of this project only looked at still image frames, but it is entirely possible to
                            record and process videos using OpenCV libraries. It would be interesting to then create
                            different
                            video effects, such as slow motion, timelapse, boomerang, or moving average,
                            in addition to the traditional image processing effects which you can apply to each frame.
                        </p>

                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h4>Trying different servers and models</h4>
                        <p>We only implemented 2 different models on 1 t2.medium instance.
                            It would be interesting to try many other machine learning classifiers,
                            such as different object detection algorithms, and use more expensive instances,
                            to speed up the computation as much as possible on the most computation heavy types of
                            models.

                            Specifically, we could try to use YOLO: Real Time Object Detection, in conjunction with
                            video,
                            and output live transformations on to the piTFT. We could have YOLO run on compute-heavy
                            servers,
                            or try TinyYOLO (a lightweight version of YOLO) on the Pi. Although, YOLO does not return
                            Masks of
                            objects, it only returns the bounding boxes around them.
                        </p>

                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h4>More Effects</h4>
                        <p>Only around 12 different image effects are included so far, but there are a multitude of
                            other options to explore! We could take to instagram and Snapchat as inspiration and attempt
                            to create dynamic filter effects and image additions. Alternatively, we could explore more
                            traditional filters such as histogram equalization, adaptive thresholding, or gradient
                            images.</p>

                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="blog-details-text">

                        <h4>Follow best practices!</h4>
                        <p>Just a note - make sure to follow AWS best practices or AWS will come after you. We
                            accidently pushed our AWS credentials to github, which invoked AWS GuardDuty and put a
                            ticket against our account as being compromised. We had to deal with several employees and
                            rotate all our keys and passwords to re-secure the account.
                            </br>
                            There are also other standards to follow, such as making sure you don’t use your root
                            account for everything, rather, you can make separate Users and assign them individual
                            permissions, known as Roles. In this case, we made a separate User with an S3 role.
                        </p>

                    </div>
                </div>
            </div>

        </div>
    </section>
    <!-- Features Area End -->
    <!-- Call To Action Area End -->

    <!-- Support Area Start -->
    <section id="Appendix" class="hami-support-area bg-gray mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="support-text">
                        <h2>Appendix</h2>
                    </div>
                </div>
            </div>
        </div>


        <!-- Support Pattern -->
        <div class="support-pattern" style="background-image: url(img/core-img/support-pattern.png);"></div>
    </section>
    <!-- Support Area End -->

    <!-- Call To Action Area Start -->
    <section class="hami-cta-area">

        <div class="container">
            <div class="row justify-content-center">

                <!-- Appendix Chunk -->
                <div class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Appendix A: Work Distribution</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <div class="row justify-content-center mb-15">
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/happy_laas.jpg" alt="laas">
                                    <u>Laasya</u>
                                    <ul>
                                        <li>Camera Fine Tuning</li>
                                        <li>CloudCam state machine logic</li>
                                        <li>Image effects code </li>
                                        <li>RPi Graphic display</li>
                                        <li>Final Report</li>
                                    </ul>
                                </div>
                                <div>
                                    <img class="rounded mx-auto d-block" src="img/rpi-img/happy_man.jpg" alt="ani">
                                    <u>Anirudh</u>
                                    <ul>
                                        <li>ML Server Setup</li>
                                        <li>S3 integration for cloud storage</li>
                                        <li>AWS integration for both ML models</li>
                                        <li>Website design and coding</li>
                                        <li>Final Report</li>
                                    </ul>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- Appendix Chunk -->
                <div class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Appendix B: References</h2>
                        </div>
                        <!-- Description -->
                        <div class="row justify-content-center mb-15" style="margin:5px">
                            <div class="col-6">
                                <h4>Image Processing resources:</h4>
                                <a style="color:blue"
                                    href="https://docs.opencv.org/3.4/d3/dc1/tutorial_basic_linear_transform.html">Basic
                                    Linear Transforms</a><br>
                                <a style="color:blue"
                                    href="https://docs.opencv.org/master/d1/d5c/tutorial_py_kmeans_opencv.htm">KMeans in
                                    Image Processing</a><br>
                                <a style="color:blue"
                                    href="https://docs.opencv.org/3.4.8/d4/d13/tutorial_py_filtering.htmll">Image
                                    Filtering in OpenCV</a><br>
                                <a style="color:blue"
                                    href="https://towardsdatascience.com/python-opencv-building-instagram-like-image-filters-5c482c1c5079">Building
                                    Instagram-Like Image Filters</a><br>
                                <a style="color:blue"
                                    href="https://stackoverflow.com/questions/55508615/how-to-pixelate-image-using-opencv-in-python">Pixelating
                                    Images</a><br>
                                <a style="color:blue"
                                    href="https://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_imgproc/py_canny/py_canny.html">Canny
                                    Edge Detection</a><br>
                                <a style="color:blue"
                                    href="https://courses.ece.cornell.edu/ece5990/ECE5990_Fall15_FinalProjects/Feng-ming_Chang/dreamweaver/main">Student
                                    project from ECE 5725 2015fa</a><br>
                                <a style="color:blue" href="http://filters.sourceforge.net/filterslist.htm">List of
                                    common image
                                    filters</a><br>
                                <a style="color:blue"
                                    href="https://github.com/oarriaga/face_classification/blob/master/report.pdf">Face
                                    classification</a><br>
                                <a style="color:blue"
                                    href="https://gluon-cv.mxnet.io/build/examples_instance/demo_mask_rcnn.html">Mask
                                    RCNN Resource</a><br>
                            </div>
                            <div class="col-6">
                                <h4>AWS, ML, and Server resources: </h4>
                                <a style="color:blue" href="https://aws.amazon.com/ec2/pricing/on-demand/">EC2 Instance
                                    Pricing</a> <br>
                                <a style="color:blue"
                                    href="https://docs.aws.amazon.com/AmazonS3/latest/dev/MakingRequests.html">Making S3
                                    Requests</a><br>
                                <a style="color:blue" href="https://aws.amazon.com/ec2/">AWS EC2 Documentation</a><br>
                                <a style="color:blue"
                                    href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html">AWS Lambda
                                    Documentation</a><br>
                                <a style="color:blue" href=" https://aws.amazon.com/greengrass/">AWS Greengrass
                                    Documentation</a><br>
                                <a style="color:blue"
                                    href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-18-04?fbclid=IwAR3DyOy-VuA83ccpaB4jJgcAFkIZGFCDzFuVgSzKwKEpiS_CtN_fL5Xh9v0">Flask
                                    applications with gunicorn and nginx</a><br>
                                <a style="color:blue" href="https://vsupalov.com/gunicorn-and-nginx/">Gunicorn and
                                    nginx</a><br>
                                <a style="color:blue"
                                    href="https://aws.amazon.com/blogs/machine-learning/how-to-deploy-deep-learning-models-with-aws-lambda-and-tensorflow/">Deep
                                    Learning Models with Lambda and TensorFlow</a><br>


                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appendix Chunk -->
                <div class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Appendix C: Budget</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Part</th>
                                        <th scope="col">Quantity</th>
                                        <th scope="col">Unit Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th scope="row">Raspberry Pi 3B</th>
                                        <td>1</td>
                                        <td>Including</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Raspberry Pi Camera Module v2</th>
                                        <td>1</td>
                                        <td>Included</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">AWS EC2 Servers</th>
                                        <td>1</td>
                                        <td>$1.64</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h4>Total: $1.64</h4>
                        </div>
                    </div>
                </div>

                <!-- Appendix Chunk -->
                <div class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Appendix D: CloudCam Code</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <!-- HTML generated using hilite.me -->
                            <div
                                style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
                                <pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi.GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pygame</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pygame.locals</span> <span style="color: #008800; font-weight: bold">import</span><span style="color: #333333">*</span>  <span style="color: #888888"># for event MOUSE variables</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">collections</span> <span style="color: #008800; font-weight: bold">import</span> deque
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">math</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">io</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">picamera</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">picamera</span> <span style="color: #008800; font-weight: bold">import</span> PiCamera
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">scipy.interpolate</span> <span style="color: #008800; font-weight: bold">import</span> UnivariateSpline
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">simple_image_commands</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">requests</span>




os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_VIDEODRIVER&#39;</span>, <span style="background-color: #fff0f0">&#39;fbcon&#39;</span>)
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_FBDEV&#39;</span>, <span style="background-color: #fff0f0">&#39;/dev/fb1&#39;</span>)
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_MOUSEDRV&#39;</span>, <span style="background-color: #fff0f0">&#39;TSLIB&#39;</span>) <span style="color: #888888"># Track Mouse clicks on piTFT</span>
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_MOUSEDEV&#39;</span>, <span style="background-color: #fff0f0">&#39;/dev/input/touchscreen&#39;</span>)

<span style="color: #888888">####### INITIALIZATION ####################################</span>

GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)

<span style="color: #888888"># piTFT buttons</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">17</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">22</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">23</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">27</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)

pygame<span style="color: #333333">.</span>init()
pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>set_visible(<span style="color: #007020">False</span>)

BLACK <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>)
WHITE <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>)
RED <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>)
GREEN <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>)
BLUE <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>)

menu_font <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>font<span style="color: #333333">.</span>SysFont(<span style="background-color: #fff0f0">&quot;caveat&quot;</span>, <span style="color: #0000DD; font-weight: bold">30</span>)
screen <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>set_mode((<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>), pygame<span style="color: #333333">.</span>FULLSCREEN)
screen<span style="color: #333333">.</span>fill(BLACK)

<span style="color: #888888">#####################Class Definition#####################</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Wheesh</span>:
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>camera <span style="color: #333333">=</span> PiCamera()
        <span style="color: #888888"># we can make this the same as ScreenWidth/Height if u want, or have the image take up a different size</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>camera<span style="color: #333333">.</span>resolution <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">240</span>)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>camera<span style="color: #333333">.</span>rotation <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">270</span>

        <span style="color: #007020">self</span><span style="color: #333333">.</span>menu_font <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>font<span style="color: #333333">.</span>SysFont(<span style="background-color: #fff0f0">&quot;caveat&quot;</span>, <span style="color: #0000DD; font-weight: bold">30</span>)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>set_mode((<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>), pygame<span style="color: #333333">.</span>FULLSCREEN)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(BLACK)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>stream <span style="color: #333333">=</span> io<span style="color: #333333">.</span>BytesIO

        <span style="color: #888888"># state system</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        <span style="color: #888888"># screen dimensions x 3 channels</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>rgb <span style="color: #333333">=</span> <span style="color: #007020">bytearray</span>(<span style="color: #0000DD; font-weight: bold">320</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">240</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">3</span>)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>current_image <span style="color: #333333">=</span> []
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>current_image
        <span style="color: #007020">self</span><span style="color: #333333">.</span>n <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>curr_filename <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>     <span style="color: #888888"># original filename</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>filename <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>          <span style="color: #888888"># edited filename</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>               <span style="color: #888888"># prefix of filenames without file extension</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>timeout <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">200</span>          <span style="color: #888888"># timeout for ML prediction downloading</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>start_time <span style="color: #333333">=</span> <span style="color: #007020">str</span>(<span style="color: #007020">int</span>(time<span style="color: #333333">.</span>time())) <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_&quot;</span>


        <span style="color: #888888"># 0:free view, 1:captured picture display (show orignal), 2: edited image</span>
        <span style="color: #888888"># 3:menu</span>

        <span style="color: #888888"># adjustment parameters</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>contrast <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>              <span style="color: #888888"># contrast --&gt; multiplication</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>brightness <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>         <span style="color: #888888"># brightness --&gt; addition     </span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">inc</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>n <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">CurrMode</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">EnterState0</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">EnterState1</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">EnterState2</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">EnterState3</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>_mainState <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">3</span>

    <span style="color: #888888">####### IMAGE PROCESSING ####################################</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">make_request</span>(<span style="color: #007020">self</span>, im, kind):
        <span style="color: #008800; font-weight: bold">if</span> kind <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&quot;mask&quot;</span>:
            resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(<span style="background-color: #fff0f0">&quot;http://ec2-34-205-78-136.compute-1.amazonaws.com:5000/mask/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag, timeout<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">150</span>)
        <span style="color: #008800; font-weight: bold">elif</span> kind <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&quot;emotion&quot;</span>:
            resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(<span style="background-color: #fff0f0">&quot;http://ec2-34-205-78-136.compute-1.amazonaws.com:5000/emotion/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag, timeout<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">25</span>)
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;not a valid req type&quot;</span>
            resp <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;:(&quot;</span>
        <span style="color: #008800; font-weight: bold">return</span> resp

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">capture</span>(<span style="color: #007020">self</span>, rgb, stop<span style="color: #333333">=</span><span style="color: #007020">False</span>, n<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">0</span>):
        stream <span style="color: #333333">=</span> io<span style="color: #333333">.</span>BytesIO()
        <span style="color: #007020">self</span><span style="color: #333333">.</span>camera<span style="color: #333333">.</span>capture(stream, resize<span style="color: #333333">=</span>(<span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">240</span>),
                            use_video_port<span style="color: #333333">=</span><span style="color: #007020">True</span>, format<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;rgb&#39;</span>)
        stream<span style="color: #333333">.</span>seek(<span style="color: #0000DD; font-weight: bold">0</span>)
        stream<span style="color: #333333">.</span>readinto(<span style="color: #007020">self</span><span style="color: #333333">.</span>rgb)

        <span style="color: #008800; font-weight: bold">if</span> stop:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>camera<span style="color: #333333">.</span>capture(<span style="background-color: #fff0f0">&quot;img_&quot;</span><span style="color: #333333">+</span><span style="color: #007020">self</span><span style="color: #333333">.</span>start_time<span style="color: #333333">+</span> <span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>n)<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;.jpg&quot;</span>)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>curr_filename  <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;img_&quot;</span><span style="color: #333333">+</span><span style="color: #007020">self</span><span style="color: #333333">.</span>start_time<span style="color: #333333">+</span> <span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>n)<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;.jpg&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>filename <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;img_&quot;</span><span style="color: #333333">+</span><span style="color: #007020">self</span><span style="color: #333333">.</span>start_time<span style="color: #333333">+</span> <span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>n)<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_edited.jpg&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;img_&quot;</span><span style="color: #333333">+</span><span style="color: #007020">self</span><span style="color: #333333">.</span>start_time<span style="color: #333333">+</span> <span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>n)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>inc()
            stream<span style="color: #333333">.</span>close()

            <span style="color: #888888"># decode = cv2.imdecode(np.asarray(rgb, np.uint8), cv2.IMREAD_COLOR)</span>
            pgi <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>image<span style="color: #333333">.</span>frombuffer(rgb, (<span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">240</span>), <span style="background-color: #fff0f0">&#39;RGB&#39;</span>)
            pgi_surf <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>surfarray<span style="color: #333333">.</span>array3d(pgi)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>current_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(
                pgi_surf<span style="color: #333333">.</span>transpose([<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">2</span>]), cv2<span style="color: #333333">.</span>COLOR_RGB2BGR)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>current_image
            test_upload(<span style="color: #007020">self</span><span style="color: #333333">.</span>curr_filename, <span style="background-color: #fff0f0">&quot;upload_folder/&quot;</span><span style="color: #333333">+</span><span style="color: #007020">self</span><span style="color: #333333">.</span>curr_filename)

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">pygamify</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #888888"># Convert cvimage into a pygame image</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(np<span style="color: #333333">.</span>shape(image)) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            image2 <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(image, cv2<span style="color: #333333">.</span>COLOR_BGR2RGB)
        <span style="color: #008800; font-weight: bold">else</span>:
            image2 <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(image, cv2<span style="color: #333333">.</span>COLOR_GRAY2RGB)
        <span style="color: #008800; font-weight: bold">return</span> pygame<span style="color: #333333">.</span>image<span style="color: #333333">.</span>frombuffer(image2<span style="color: #333333">.</span>tostring(), image2<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">1</span>::<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>], <span style="background-color: #fff0f0">&quot;RGB&quot;</span>)

    <span style="color: #888888"># Filter menu tasks: Taken from building instagram-like filters in python</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">sepia</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;sepia&quot;</span>
        kernel <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([[<span style="color: #6600EE; font-weight: bold">0.272</span>, <span style="color: #6600EE; font-weight: bold">0.534</span>, <span style="color: #6600EE; font-weight: bold">0.131</span>],
                           [<span style="color: #6600EE; font-weight: bold">0.349</span>, <span style="color: #6600EE; font-weight: bold">0.686</span>, <span style="color: #6600EE; font-weight: bold">0.168</span>],
                           [<span style="color: #6600EE; font-weight: bold">0.393</span>, <span style="color: #6600EE; font-weight: bold">0.769</span>, <span style="color: #6600EE; font-weight: bold">0.189</span>]])
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span>  cv2<span style="color: #333333">.</span>filter2D(image, <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>, kernel)

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">spreadLookupTable</span>(<span style="color: #007020">self</span>, x, y):
        spline <span style="color: #333333">=</span> UnivariateSpline(x, y)
        <span style="color: #008800; font-weight: bold">return</span> spline(<span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">256</span>))

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">warm_image</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;warm&quot;</span>
        increaseLookupTable <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>spreadLookupTable(
            [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">64</span>, <span style="color: #0000DD; font-weight: bold">128</span>, <span style="color: #0000DD; font-weight: bold">256</span>], [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">256</span>])
        decreaseLookupTable <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>spreadLookupTable(
            [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">64</span>, <span style="color: #0000DD; font-weight: bold">128</span>, <span style="color: #0000DD; font-weight: bold">256</span>], [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">256</span>])
        red_channel, green_channel, blue_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>split(image)
        red_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>LUT(red_channel, increaseLookupTable)<span style="color: #333333">.</span>astype(np<span style="color: #333333">.</span>uint8)
        blue_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>LUT(blue_channel, decreaseLookupTable)<span style="color: #333333">.</span>astype(np<span style="color: #333333">.</span>uint8)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>merge((red_channel, green_channel, blue_channel))

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cold_image</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;cold&quot;</span>
        increaseLookupTable <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>spreadLookupTable(
            [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">64</span>, <span style="color: #0000DD; font-weight: bold">128</span>, <span style="color: #0000DD; font-weight: bold">256</span>], [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">256</span>])
        decreaseLookupTable <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>spreadLookupTable(
            [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">64</span>, <span style="color: #0000DD; font-weight: bold">128</span>, <span style="color: #0000DD; font-weight: bold">256</span>], [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">256</span>])
        red_channel, green_channel, blue_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>split(image)
        red_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>LUT(red_channel, decreaseLookupTable)<span style="color: #333333">.</span>astype(np<span style="color: #333333">.</span>uint8)
        blue_channel <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>LUT(blue_channel, increaseLookupTable)<span style="color: #333333">.</span>astype(np<span style="color: #333333">.</span>uint8)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>merge((red_channel, green_channel, blue_channel))

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">gray</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;gray&quot;</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(image, cv2<span style="color: #333333">.</span>COLOR_BGR2GRAY)

    <span style="color: #888888"># &quot;Other&quot; menu tasks</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">restore</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;revert changes&quot;</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>current_image
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cluster</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;clustering&quot;</span>
        <span style="color: #888888"># single channel as float</span>
        Z <span style="color: #333333">=</span> np<span style="color: #333333">.</span>float32(image<span style="color: #333333">.</span>reshape((<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">3</span>)))
        criteria <span style="color: #333333">=</span> (cv2<span style="color: #333333">.</span>TERM_CRITERIA_EPS <span style="color: #333333">+</span> cv2<span style="color: #333333">.</span>TERM_CRITERIA_MAX_ITER, <span style="color: #0000DD; font-weight: bold">10</span>, <span style="color: #6600EE; font-weight: bold">1.0</span>)
        K <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">8</span>       <span style="color: #888888"># number of clusters</span>

        <span style="color: #888888"># perform clustering</span>
        ret, label, center <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>kmeans(Z, K, <span style="color: #007020">None</span>, criteria, <span style="color: #0000DD; font-weight: bold">10</span>, cv2<span style="color: #333333">.</span>KMEANS_RANDOM_CENTERS)

        <span style="color: #888888"># back to uint8</span>
        center <span style="color: #333333">=</span> np<span style="color: #333333">.</span>uint8(center)
        result <span style="color: #333333">=</span> center[label<span style="color: #333333">.</span>flatten()]<span style="color: #333333">.</span>reshape((image<span style="color: #333333">.</span>shape))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> result
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">pixelate</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;8bit&quot;</span>
        <span style="color: #888888"># scale image down with linear interpolation, scale back up with nearest neighbors</span>
        size <span style="color: #333333">=</span> image<span style="color: #333333">.</span>shape[:<span style="color: #0000DD; font-weight: bold">2</span>][::<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>]
        downsize <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">320</span><span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">4</span>, <span style="color: #0000DD; font-weight: bold">240</span><span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">4</span>)
        scaled_down <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>resize(image, downsize, interpolation <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>INTER_LINEAR)
        scaled_up <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>resize(scaled_down, size, interpolation <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>INTER_NEAREST)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> scaled_up

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">edge</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;edge&quot;</span>
        <span style="color: #888888"># Canny edge detection w/ hysteresis thresholding. Double check that thresholds are good.</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>Canny(image, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">200</span>)

    <span style="color: #888888"># Adjust menu tasks    </span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust_contrast</span>(<span style="color: #007020">self</span>, mode):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;contrast&quot;</span>
        <span style="color: #008800; font-weight: bold">if</span> mode <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># increase</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>contrast <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.1</span>
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>contrast <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.9</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>convertScaleAbs(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, alpha<span style="color: #333333">=</span><span style="color: #007020">self</span><span style="color: #333333">.</span>contrast)

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust_brightness</span>(<span style="color: #007020">self</span>, mode):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;brighter lol&quot;</span>
        <span style="color: #008800; font-weight: bold">if</span> mode <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># increase</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>brightness <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span>
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>brightness <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">5</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>convertScaleAbs(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, beta<span style="color: #333333">=</span><span style="color: #007020">self</span><span style="color: #333333">.</span>brightness)
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust_blur</span>(<span style="color: #007020">self</span>, mode):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;blur lol&quot;</span>
        <span style="color: #888888"># guassian blur</span>
        <span style="color: #888888"># repeatedly apply a blurring or sharpening filter (3x3) to an image with filter2D</span>
        <span style="color: #008800; font-weight: bold">if</span> mode <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># more blur</span>
            kernel <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([[<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">1</span>],[<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">9</span>,<span style="color: #0000DD; font-weight: bold">1</span>],[<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">1</span>]])<span style="color: #333333">*-</span><span style="color: #0000DD; font-weight: bold">1</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>filter2D(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>, kernel)
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>blur(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, (<span style="color: #0000DD; font-weight: bold">3</span>,<span style="color: #0000DD; font-weight: bold">3</span>))

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust_saturation</span>(<span style="color: #007020">self</span>, mode):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;saturation&quot;</span>
        <span style="color: #888888"># images stored in bgr format</span>
        imghsv <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)<span style="color: #333333">.</span>astype(<span style="background-color: #fff0f0">&quot;float32&quot;</span>)
        (h, s, v) <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>split(imghsv)
        <span style="color: #008800; font-weight: bold">if</span> mode <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># increase</span>
            s <span style="color: #333333">=</span> np<span style="color: #333333">.</span>add(s, <span style="color: #0000DD; font-weight: bold">5</span>)
        <span style="color: #008800; font-weight: bold">else</span>:
            s <span style="color: #333333">=</span> np<span style="color: #333333">.</span>add(s, <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">5</span>)
        s <span style="color: #333333">=</span> np<span style="color: #333333">.</span>clip(s,<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">255</span>)
        imghsv <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>merge([h,s,v])
        imgbgr <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(imghsv<span style="color: #333333">.</span>astype(<span style="background-color: #fff0f0">&quot;uint8&quot;</span>), cv2<span style="color: #333333">.</span>COLOR_HSV2BGR)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> imgbgr


    <span style="color: #888888">####### SCREEN UPDATES ####################################</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_text</span>(<span style="color: #007020">self</span>, s, pos):
        text <span style="color: #333333">=</span> s
        text_surface <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>menu_font<span style="color: #333333">.</span>render(s, <span style="color: #007020">True</span>, BLACK)
        rect <span style="color: #333333">=</span> text_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>pos)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>blit(text_surface, rect)

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_image</span>(<span style="color: #007020">self</span>, img, pos):
        pgi <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pygamify(img)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>blit(pgi, pos)
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>flip()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_icon</span>(<span style="color: #007020">self</span>, img_path, pos):
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;unimplemented&quot;</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_main_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;effects&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;filter&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;ML&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;adjust&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_adjust_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;blur&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;contrast&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;brightness&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;saturation&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_filter_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;warm&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;sepia&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;cool&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;noir&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_effects_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;pixelate&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;edge&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;restore&quot;</span>, (<span style="color: #0000DD; font-weight: bold">260</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;cluster&quot;</span>, (<span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_ml_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;emotion recognition&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;object detection&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_save_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;Save Edited Img?&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">20</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;YES&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;NO&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_upload_menu</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;Upload Edited Img?&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">20</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;YES&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">60</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;NO&quot;</span>, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">180</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_adjust_bar</span>(<span style="color: #007020">self</span>):
        pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>rect(screen, WHITE, (<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">200</span>, <span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">40</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;+&quot;</span>, (<span style="color: #0000DD; font-weight: bold">30</span>, <span style="color: #0000DD; font-weight: bold">220</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;-&quot;</span>, (<span style="color: #0000DD; font-weight: bold">280</span>, <span style="color: #0000DD; font-weight: bold">220</span>))
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(<span style="background-color: #fff0f0">&quot;done&quot;</span>, (<span style="color: #0000DD; font-weight: bold">140</span>, <span style="color: #0000DD; font-weight: bold">220</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">blit_message</span>(<span style="color: #007020">self</span>, message):
        <span style="color: #888888"># another form of blit text</span>
        <span style="color: #007020">self</span><span style="color: #333333">.</span>screen<span style="color: #333333">.</span>fill(WHITE)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_text(message, (<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">120</span>))
        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()

    <span style="color: #888888">####### EVENT HANDLING ####################################</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">get_quadrant</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">for</span> event <span style="color: #000000; font-weight: bold">in</span> pygame<span style="color: #333333">.</span>event<span style="color: #333333">.</span>get():
            <span style="color: #008800; font-weight: bold">if</span> event<span style="color: #333333">.</span>type <span style="color: #333333">==</span> pygame<span style="color: #333333">.</span>QUIT:
                sys<span style="color: #333333">.</span>exit()
            <span style="color: #008800; font-weight: bold">elif</span>(event<span style="color: #333333">.</span>type <span style="color: #000000; font-weight: bold">is</span> MOUSEBUTTONDOWN):
                pos <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>get_pos()
            <span style="color: #008800; font-weight: bold">elif</span>(event<span style="color: #333333">.</span>type <span style="color: #000000; font-weight: bold">is</span> MOUSEBUTTONUP):
                pos <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>get_pos()
                x, y <span style="color: #333333">=</span> pos
                <span style="color: #888888"># quit button (before game)</span>
                <span style="color: #008800; font-weight: bold">if</span> x <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">180</span> <span style="color: #000000; font-weight: bold">and</span> y <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">120</span>:
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>
                <span style="color: #008800; font-weight: bold">elif</span> x <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">180</span> <span style="color: #000000; font-weight: bold">and</span> y <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">120</span>:
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">2</span>
                <span style="color: #008800; font-weight: bold">elif</span> x <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">180</span> <span style="color: #000000; font-weight: bold">and</span> y <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">120</span>:
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">3</span>
                <span style="color: #008800; font-weight: bold">else</span>:
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">4</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>

    <span style="color: #888888"># handle contrast bar press</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">get_bar_press</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">for</span> event <span style="color: #000000; font-weight: bold">in</span> pygame<span style="color: #333333">.</span>event<span style="color: #333333">.</span>get():
            <span style="color: #008800; font-weight: bold">if</span> event<span style="color: #333333">.</span>type <span style="color: #333333">==</span> pygame<span style="color: #333333">.</span>QUIT:
                sys<span style="color: #333333">.</span>exit()
            <span style="color: #008800; font-weight: bold">elif</span>(event<span style="color: #333333">.</span>type <span style="color: #000000; font-weight: bold">is</span> MOUSEBUTTONDOWN):
                pos <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>get_pos()
            <span style="color: #008800; font-weight: bold">elif</span>(event<span style="color: #333333">.</span>type <span style="color: #000000; font-weight: bold">is</span> MOUSEBUTTONUP):
                pos <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>get_pos()
                x, y <span style="color: #333333">=</span> pos
                <span style="color: #888888"># quit button (before game)</span>
                <span style="color: #008800; font-weight: bold">if</span> x <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">70</span> <span style="color: #000000; font-weight: bold">and</span> y <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">200</span> :
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>
                <span style="color: #008800; font-weight: bold">elif</span> x <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">250</span> <span style="color: #000000; font-weight: bold">and</span> y <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">200</span>:
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">2</span>
                <span style="color: #008800; font-weight: bold">elif</span> y <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">200</span> <span style="color: #000000; font-weight: bold">and</span> x <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">50</span>,<span style="color: #0000DD; font-weight: bold">250</span>):
                    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">3</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_filter_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>warm_image(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>sepia(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>cold_image(image)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>gray(image)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>
        _
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_effects_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;8bit&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>pixelate(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;kmeans cluster&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>cluster(image)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;edge&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>edge(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;restore to default..&quot;</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>restore()
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_contrast_bar</span>(<span style="color: #007020">self</span>, adjust_method):
        <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_adjust_bar()
        option <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_bar_press()
        <span style="color: #008800; font-weight: bold">if</span> option <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;plus&quot;</span>
            adjust_method(<span style="color: #0000DD; font-weight: bold">0</span>)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_image(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image,(<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>))
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_adjust_bar()
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> option <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;minus&quot;</span>
            adjust_method(<span style="color: #0000DD; font-weight: bold">1</span>)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_image(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image,(<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>))
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_adjust_bar()
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> option <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;submit&quot;</span>
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_adjust_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_image(image,(<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>))
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_adjust_bar()

        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">not</span> done_adjusting:
                done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_contrast_bar(<span style="color: #007020">self</span><span style="color: #333333">.</span>adjust_brightness)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">not</span> done_adjusting:
                done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_contrast_bar(<span style="color: #007020">self</span><span style="color: #333333">.</span>adjust_blur)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">not</span> done_adjusting:
                done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_contrast_bar(<span style="color: #007020">self</span><span style="color: #333333">.</span>adjust_contrast)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">not</span> done_adjusting:
                done_adjusting <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_contrast_bar(<span style="color: #007020">self</span><span style="color: #333333">.</span>adjust_saturation)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_ml_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #000000; font-weight: bold">or</span>  quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #888888"># get emotion image by s3 download</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_message(<span style="background-color: #fff0f0">&quot;loading detection...&quot;</span>)
            <span style="color: #008800; font-weight: bold">try</span>:
                <span style="color: #008800; font-weight: bold">print</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag
                test_download(local_download_path <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>, s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>)
                <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>imread(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>)
                <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
                <span style="color: #888888"># file doesn&#39;t exist yet</span>
                code <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">404</span>
                current_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
                <span style="color: #008800; font-weight: bold">while</span> code <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">404</span> <span style="color: #000000; font-weight: bold">and</span> time<span style="color: #333333">.</span>time()<span style="color: #333333">-</span>current_time <span style="color: #333333">&lt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>timeout:
                    curr_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
                    <span style="color: #008800; font-weight: bold">try</span>:
                        resp <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>make_request(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag, <span style="background-color: #fff0f0">&quot;emotion&quot;</span>)
                    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
                        <span style="color: #008800; font-weight: bold">print</span> e
                    code <span style="color: #333333">=</span> resp<span style="color: #333333">.</span>status_code
                    <span style="color: #008800; font-weight: bold">print</span> resp
                    <span style="color: #008800; font-weight: bold">print</span> time<span style="color: #333333">.</span>time()<span style="color: #333333">-</span>curr_time
                    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;get&quot;</span>
                <span style="color: #008800; font-weight: bold">if</span> code <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">404</span>:
                    <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_message(<span style="background-color: #fff0f0">&quot;prediction failed :(&quot;</span>)
                    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #008800; font-weight: bold">else</span>:
                    test_download(local_download_path <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>, s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>)
                    <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>imread(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>)
                <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
            
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #000000; font-weight: bold">or</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #888888"># get mask image</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_message(<span style="background-color: #fff0f0">&quot;loading detection...&quot;</span>)
            <span style="color: #008800; font-weight: bold">try</span>:
                test_download(local_download_path <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>, s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>)
                <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>imread(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>)
                <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>resize(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, (<span style="color: #0000DD; font-weight: bold">320</span>,<span style="color: #0000DD; font-weight: bold">240</span>))
                <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
            <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
                <span style="color: #888888"># file doesn&#39;t exist yet</span>
                code <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">404</span>
                current_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
                <span style="color: #008800; font-weight: bold">while</span> code <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">404</span> <span style="color: #000000; font-weight: bold">and</span> time<span style="color: #333333">.</span>time()<span style="color: #333333">-</span>current_time <span style="color: #333333">&lt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>timeout:
                    curr_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
                    resp <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>make_request(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag, <span style="background-color: #fff0f0">&quot;mask&quot;</span>)
                    code <span style="color: #333333">=</span> resp<span style="color: #333333">.</span>status_code
                    <span style="color: #008800; font-weight: bold">print</span> resp
                    <span style="color: #008800; font-weight: bold">print</span> time<span style="color: #333333">.</span>time()<span style="color: #333333">-</span>curr_time
                    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;get&quot;</span>
                <span style="color: #008800; font-weight: bold">if</span> code <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">404</span>:
                    <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_message(<span style="background-color: #fff0f0">&quot;prediction failed :(&quot;</span>)
                    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #008800; font-weight: bold">else</span>:
                    test_download(local_download_path <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>, s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>tag <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>)
                    <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>imread(<span style="color: #007020">self</span><span style="color: #333333">.</span>tag<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>)
                    <span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>resize(<span style="color: #007020">self</span><span style="color: #333333">.</span>edited_image, (<span style="color: #0000DD; font-weight: bold">320</span>,<span style="color: #0000DD; font-weight: bold">240</span>))
                <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
            
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_main_menu</span>(<span style="color: #007020">self</span>, image):
        <span style="color: #888888"># case switch for each of the different quadrants</span>
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #888888"># open adjustment menu</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_adjust_menu()
            adjusting <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            <span style="color: #008800; font-weight: bold">while</span> adjusting:
                adjusting <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_adjust_menu(image)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            <span style="color: #888888"># open filtering l2 menu</span>
            filtering <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_filter_menu()
            <span style="color: #008800; font-weight: bold">while</span> filtering:
                filtering <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_filter_menu(image)
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_effects_menu()
            handling <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            <span style="color: #008800; font-weight: bold">while</span> handling:
                handling <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_effects_menu(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            <span style="color: #007020">self</span><span style="color: #333333">.</span>blit_ml_menu()
            handling <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            <span style="color: #008800; font-weight: bold">while</span> handling:
                handling <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>handle_ml_menu(image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>

        <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">True</span>
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_save_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #000000; font-weight: bold">or</span>  quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #888888"># save image</span>
            cv2<span style="color: #333333">.</span>imwrite(<span style="color: #007020">self</span><span style="color: #333333">.</span>filename, image)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #000000; font-weight: bold">or</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #888888"># do nothing</span>
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">handle_upload_menu</span>(<span style="color: #007020">self</span>, image):
        quad <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_quadrant()
        <span style="color: #008800; font-weight: bold">if</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #000000; font-weight: bold">or</span>  quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">4</span>:
            <span style="color: #888888"># upload image</span>
            <span style="color: #008800; font-weight: bold">print</span> quad
            cv2<span style="color: #333333">.</span>imwrite(<span style="color: #007020">self</span><span style="color: #333333">.</span>filename, image)
            test_upload(local_filename <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>filename, s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;edited/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>filename)
            <span style="color: #008800; font-weight: bold">return</span>  <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">elif</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #000000; font-weight: bold">or</span> quad <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #888888"># do nothing</span>
            <span style="color: #008800; font-weight: bold">print</span> quad
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>


<span style="color: #888888">####### MAIN LOOP ####################################</span>
w <span style="color: #333333">=</span> Wheesh()

<span style="color: #888888">############ MAIN LOOP #########################</span>
<span style="color: #008800; font-weight: bold">try</span>:
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #888888"># free view mode: menu isnt open and we aren&#39;t on a frame</span>
        <span style="color: #008800; font-weight: bold">if</span> w<span style="color: #333333">.</span>CurrMode() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:  <span style="color: #888888"># free viewing mode, have ability to take a picture</span>
            <span style="color: #008800; font-weight: bold">try</span>:
                w<span style="color: #333333">.</span>capture(w<span style="color: #333333">.</span>rgb)
                img <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>image<span style="color: #333333">.</span>frombuffer(w<span style="color: #333333">.</span>rgb, (<span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">240</span>), <span style="background-color: #fff0f0">&#39;RGB&#39;</span>)
                w<span style="color: #333333">.</span>screen<span style="color: #333333">.</span>blit(img, (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>))
            <span style="color: #008800; font-weight: bold">except</span> :
                <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;exceptioned&quot;</span>
                GPIO<span style="color: #333333">.</span>cleanup()
                w<span style="color: #333333">.</span>camera<span style="color: #333333">.</span>close()
                quit()
                <span style="color: #008800; font-weight: bold">continue</span>
            <span style="color: #888888"># take a picture</span>
            <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>)):
                w<span style="color: #333333">.</span>capture(w<span style="color: #333333">.</span>rgb, <span style="color: #007020">True</span>, w<span style="color: #333333">.</span>n)
                <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;picture taken&quot;</span>)
                w<span style="color: #333333">.</span>EnterState1()

        <span style="color: #888888"># captured picture display mode / (show orignal)</span>
        <span style="color: #008800; font-weight: bold">if</span> w<span style="color: #333333">.</span>CurrMode() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
            w<span style="color: #333333">.</span>blit_image(w<span style="color: #333333">.</span>current_image, (<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>)) <span style="color: #888888">#either update display right here, or move the blit into the &quot;enter&quot; functions</span>
            <span style="color: #008800; font-weight: bold">if</span> ( <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">23</span>) ):
                <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;displaying edited image&quot;</span>
                w<span style="color: #333333">.</span>EnterState2()

            <span style="color: #888888"># only open menu when frozen</span>
            <span style="color: #008800; font-weight: bold">if</span> ( <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">22</span>) ):
                <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;opening main menu...&quot;</span>
                w<span style="color: #333333">.</span>EnterState3()

            <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>)):
                <span style="color: #888888"># todo: open save menu</span>
                w<span style="color: #333333">.</span>blit_save_menu()
                time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                save_menu_open <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                <span style="color: #888888"># process save menu actions:</span>
                <span style="color: #008800; font-weight: bold">while</span> save_menu_open:
                    save_menu_open <span style="color: #333333">=</span> w<span style="color: #333333">.</span>handle_save_menu(w<span style="color: #333333">.</span>edited_image)
                w<span style="color: #333333">.</span>blit_upload_menu()
                upload_menu_open <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #888888"># process upload menu actions:</span>
                <span style="color: #008800; font-weight: bold">while</span> upload_menu_open:
                    upload_menu_open <span style="color: #333333">=</span> w<span style="color: #333333">.</span>handle_upload_menu(w<span style="color: #333333">.</span>edited_image)
                w<span style="color: #333333">.</span>EnterState0()

        <span style="color: #888888"># edited picture display mode (show edited)</span>
        <span style="color: #008800; font-weight: bold">if</span> w<span style="color: #333333">.</span>CurrMode() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span>:
            w<span style="color: #333333">.</span>blit_image(w<span style="color: #333333">.</span>edited_image, (<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>))
            <span style="color: #008800; font-weight: bold">if</span> ( <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">23</span>) ):
                <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;displaying original image&quot;</span>
                w<span style="color: #333333">.</span>EnterState1()

            <span style="color: #888888"># only open menu when frozen: can open menu from edited image</span>
            <span style="color: #008800; font-weight: bold">if</span> ( <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">22</span>) ):
                <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;opening main menu...&quot;</span>
                w<span style="color: #333333">.</span>EnterState3()

            <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>)):
                <span style="color: #888888"># todo: open save menu</span>
                w<span style="color: #333333">.</span>blit_save_menu()
                time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                save_menu_open <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                <span style="color: #888888"># process save menu actions:</span>
                <span style="color: #008800; font-weight: bold">while</span> save_menu_open:
                    save_menu_open <span style="color: #333333">=</span> w<span style="color: #333333">.</span>handle_save_menu(w<span style="color: #333333">.</span>edited_image)
                w<span style="color: #333333">.</span>blit_upload_menu()
                upload_menu_open <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #888888"># process upload menu actions:</span>
                <span style="color: #008800; font-weight: bold">while</span> upload_menu_open:
                    upload_menu_open <span style="color: #333333">=</span> w<span style="color: #333333">.</span>handle_upload_menu(w<span style="color: #333333">.</span>edited_image)
                w<span style="color: #333333">.</span>EnterState0()

        <span style="color: #888888"># effects main menu mode</span>
        <span style="color: #008800; font-weight: bold">if</span> w<span style="color: #333333">.</span>CurrMode() <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
            <span style="color: #888888"># if main menu is not open</span>
            w<span style="color: #333333">.</span>blit_main_menu()
            main_menu_open <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            <span style="color: #888888"># process menu actions:</span>
            <span style="color: #008800; font-weight: bold">while</span> main_menu_open:
                main_menu_open <span style="color: #333333">=</span> w<span style="color: #333333">.</span>handle_main_menu(w<span style="color: #333333">.</span>edited_image)
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;done with menu. showing edited image now&quot;</span>
            w<span style="color: #333333">.</span>EnterState2()

        <span style="color: #888888"># quit at any time</span>
        <span style="color: #008800; font-weight: bold">if</span> ( <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">27</span>) ):
            <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Thanks for trying out the SmartCam :)&quot;</span>
            GPIO<span style="color: #333333">.</span>cleanup()
            w<span style="color: #333333">.</span>camera<span style="color: #333333">.</span>close()
            quit()

        pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>update()



<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
    GPIO<span style="color: #333333">.</span>cleanup()
    w<span style="color: #333333">.</span>camera<span style="color: #333333">.</span>close()
    quit()
</pre>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Appendix Chunk -->
                <div class="col-12">
                    <div class="card mb-100">
                        <!-- Title -->
                        <div class="price-plan-title">
                            <h2>Appendix E: Server Code</h2>
                        </div>
                        <!-- Description -->
                        <div class="price-plan-desc">
                            <!-- HTML generated using hilite.me -->
                            <div
                                style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
                                <table>
                                    <tr>
                                        <td>
                                            <pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212</pre>
                                        </td>
                                        <td>
                                            <pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">matplotlib</span> <span style="color: #008800; font-weight: bold">import</span> pyplot <span style="color: #008800; font-weight: bold">as</span> plt
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">gluoncv</span> <span style="color: #008800; font-weight: bold">import</span> model_zoo, data, utils
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">logging</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">boto3</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">keras.models</span> <span style="color: #008800; font-weight: bold">import</span> load_model
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> Flask
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">face_classification.src.image_emotion_gender_demo_modified</span> <span style="color: #008800; font-weight: bold">import</span> demo_emotion

app <span style="color: #333333">=</span> Flask(__name__)

ACCESS_KEY_ID <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
ACCESS_SECRET_KEY <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
BUCKET_NAME <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;raspi-smart-camera&#39;</span>

jpg <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;.jpg&quot;</span>

<span style="color: #888888"># Run MaskRCNN with a pretrained model</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">run_mask_model</span>(image_str):
    net <span style="color: #333333">=</span> model_zoo<span style="color: #333333">.</span>get_model(<span style="background-color: #fff0f0">&#39;mask_rcnn_resnet50_v1b_coco&#39;</span>, pretrained<span style="color: #333333">=</span><span style="color: #007020">True</span>)
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;downloaded the model&quot;</span>)
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Starting Inference&quot;</span>)

    im_fname <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> jpg
    x, orig_img <span style="color: #333333">=</span> data<span style="color: #333333">.</span>transforms<span style="color: #333333">.</span>presets<span style="color: #333333">.</span>rcnn<span style="color: #333333">.</span>load_test(im_fname)
    ids, scores, bboxes, masks <span style="color: #333333">=</span> [xx[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">.</span>asnumpy() <span style="color: #008800; font-weight: bold">for</span> xx <span style="color: #000000; font-weight: bold">in</span> net(x)]
    width, height <span style="color: #333333">=</span> orig_img<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">1</span>], orig_img<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">0</span>]
    masks, _ <span style="color: #333333">=</span> utils<span style="color: #333333">.</span>viz<span style="color: #333333">.</span>expand_mask(masks, bboxes, (width, height), scores)
    orig_img <span style="color: #333333">=</span> utils<span style="color: #333333">.</span>viz<span style="color: #333333">.</span>plot_mask(orig_img, masks)

    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;finished mask classification, making plot&quot;</span>)

    fig <span style="color: #333333">=</span> plt<span style="color: #333333">.</span>figure(figsize<span style="color: #333333">=</span>(<span style="color: #0000DD; font-weight: bold">10</span>, <span style="color: #0000DD; font-weight: bold">10</span>), frameon<span style="color: #333333">=</span><span style="color: #007020">False</span>)
    ax <span style="color: #333333">=</span> fig<span style="color: #333333">.</span>add_subplot(<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #0000DD; font-weight: bold">1</span>)
    ax <span style="color: #333333">=</span> utils<span style="color: #333333">.</span>viz<span style="color: #333333">.</span>plot_bbox(orig_img, bboxes, scores, ids,
                            class_names<span style="color: #333333">=</span>net<span style="color: #333333">.</span>classes, ax<span style="color: #333333">=</span>ax)
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Plotted the mask model output&quot;</span>)
    <span style="color: #888888"># fig.set_size_inches(w,h)</span>

    <span style="color: #888888"># plot final image without axis</span>
    ax<span style="color: #333333">.</span>set_axis_off()
    <span style="color: #888888"># fig.add_axes(ax)</span>
    <span style="color: #888888"># ax.imshow(orig_img, aspect=&#39;auto&#39;)</span>

    plt<span style="color: #333333">.</span>savefig(<span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask&quot;</span> <span style="color: #333333">+</span> jpg, bbox_inches<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;tight&#39;</span>, pad_inches<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">0</span>)
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;End of MaskRCNN&quot;</span>)

<span style="color: #888888"># Run Emotion Detection with a pretrained model (located in a different directory)</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">run_emotion_model</span>(image_str):
    demo_emotion(image_str)

<span style="color: #888888"># Run both models</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">classify</span>(image_str):
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Starting Classify&quot;</span>)
    start <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
    run_mask_model(image_str)
    end1 <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Execution time for emotion: &quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(end1<span style="color: #333333">-</span>start))
    run_emotion_model(image_str)
    end2 <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Execution time for mask: &quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(end2<span style="color: #333333">-</span>end1))

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">test_download</span>(image_str):
    s3 <span style="color: #333333">=</span> boto3<span style="color: #333333">.</span>resource(
        <span style="background-color: #fff0f0">&#39;s3&#39;</span>,
        aws_access_key_id<span style="color: #333333">=</span>ACCESS_KEY_ID,
        aws_secret_access_key<span style="color: #333333">=</span>ACCESS_SECRET_KEY,
    )

    s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;upload_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(image_str)
    local_download_path <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #888888">#include the file name</span>

    <span style="color: #888888"># Image download</span>
    s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>download_file(s3_file_name, local_download_path); <span style="color: #888888"># Change the second part</span>
    <span style="color: #888888"># This is where you want to download it too.</span>
    <span style="color: #888888"># I believe the semicolon is there on purpose</span>
    <span style="color: #008800; font-weight: bold">print</span> (<span style="background-color: #fff0f0">&quot;Download Done&quot;</span>)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">download</span>(image_str):
    s3 <span style="color: #333333">=</span> boto3<span style="color: #333333">.</span>resource(
        <span style="background-color: #fff0f0">&#39;s3&#39;</span>,
        aws_access_key_id<span style="color: #333333">=</span>ACCESS_KEY_ID,
        aws_secret_access_key<span style="color: #333333">=</span>ACCESS_SECRET_KEY,
    )

    s3_file_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;upload_folder/&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(image_str) <span style="color: #333333">+</span> jpg
    local_download_path <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> jpg <span style="color: #888888">#include the file name</span>

    <span style="color: #008800; font-weight: bold">try</span>:
    <span style="color: #888888"># Image download</span>
        s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>download_file(s3_file_name, local_download_path); <span style="color: #888888"># Change the second part</span>
        logging<span style="color: #333333">.</span>info(<span style="background-color: #fff0f0">&quot;Successfully uploaded file {} to S3 bucket {}/{}.&quot;</span><span style="color: #333333">.</span>format(local_download_path, BUCKET_NAME, s3_file_name))
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Error: could not upload file:&quot;</span> <span style="color: #333333">+</span> local_download_path <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; to s3:&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(e))

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">upload</span>(image_str):
    local_filename1 <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>
    local_filename2 <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>

    s3_filename1 <span style="color: #333333">=</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>
    s3_filename2 <span style="color: #333333">=</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>

    <span style="color: #888888">#note the s3 filename/path is set differently and has to be listed manually</span>

    data1 <span style="color: #333333">=</span> <span style="color: #007020">open</span>(local_filename1, <span style="background-color: #fff0f0">&#39;rb&#39;</span>)
    data2 <span style="color: #333333">=</span> <span style="color: #007020">open</span>(local_filename2, <span style="background-color: #fff0f0">&#39;rb&#39;</span>)

    s3 <span style="color: #333333">=</span> boto3<span style="color: #333333">.</span>resource(
        <span style="background-color: #fff0f0">&#39;s3&#39;</span>,
        aws_access_key_id<span style="color: #333333">=</span>ACCESS_KEY_ID,
        aws_secret_access_key<span style="color: #333333">=</span>ACCESS_SECRET_KEY,
    )
    <span style="color: #008800; font-weight: bold">try</span>:
        s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>put_object(Key<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> s3_filename1, Body<span style="color: #333333">=</span>data1)
        logging<span style="color: #333333">.</span>info(<span style="background-color: #fff0f0">&quot;Successfully uploaded file {} to S3 bucket {}/{}.&quot;</span><span style="color: #333333">.</span>format(local_filename1, BUCKET_NAME, s3_filename1))
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Error: could not upload file:&quot;</span> <span style="color: #333333">+</span> local_filename1 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; to s3:&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(e))

    <span style="color: #008800; font-weight: bold">try</span>:
        s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>put_object(Key<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> s3_filename2, Body<span style="color: #333333">=</span>data2)
        logging<span style="color: #333333">.</span>info(<span style="background-color: #fff0f0">&quot;Successfully uploaded file {} to S3 bucket {}/{}.&quot;</span><span style="color: #333333">.</span>format(local_filename2, BUCKET_NAME, s3_filename2))
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Error: could not upload file:&quot;</span> <span style="color: #333333">+</span> local_filename2 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; to s3:&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(e))

    <span style="color: #008800; font-weight: bold">print</span> (<span style="background-color: #fff0f0">&quot;Upload Done&quot;</span>)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">upload_mask</span>(image_str):
    local_filename1 <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>

    s3_filename1 <span style="color: #333333">=</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_mask.jpg&quot;</span>

    <span style="color: #888888">#note the s3 filename/path is set differently and has to be listed manually</span>

    data1 <span style="color: #333333">=</span> <span style="color: #007020">open</span>(local_filename1, <span style="background-color: #fff0f0">&#39;rb&#39;</span>)

    s3 <span style="color: #333333">=</span> boto3<span style="color: #333333">.</span>resource(
        <span style="background-color: #fff0f0">&#39;s3&#39;</span>,
        aws_access_key_id<span style="color: #333333">=</span>ACCESS_KEY_ID,
        aws_secret_access_key<span style="color: #333333">=</span>ACCESS_SECRET_KEY,
    )
    <span style="color: #008800; font-weight: bold">try</span>:
        s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>put_object(Key<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> s3_filename1, Body<span style="color: #333333">=</span>data1)
        logging<span style="color: #333333">.</span>info(<span style="background-color: #fff0f0">&quot;Successfully uploaded file {} to S3 bucket {}/{}.&quot;</span><span style="color: #333333">.</span>format(local_filename1, BUCKET_NAME, s3_filename1))
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Error: could not upload file:&quot;</span> <span style="color: #333333">+</span> local_filename1 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; to s3:&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(e))

    <span style="color: #008800; font-weight: bold">print</span> (<span style="background-color: #fff0f0">&quot;Upload Mask Done: &quot;</span> <span style="color: #333333">+</span> image_str)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">upload_emotion</span>(image_str):
    local_filename2 <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;images/&quot;</span> <span style="color: #333333">+</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>

    s3_filename2 <span style="color: #333333">=</span> image_str <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot;_emotion.jpg&quot;</span>

    <span style="color: #888888">#note the s3 filename/path is set differently and has to be listed manually</span>

    data2 <span style="color: #333333">=</span> <span style="color: #007020">open</span>(local_filename2, <span style="background-color: #fff0f0">&#39;rb&#39;</span>)

    s3 <span style="color: #333333">=</span> boto3<span style="color: #333333">.</span>resource(
        <span style="background-color: #fff0f0">&#39;s3&#39;</span>,
        aws_access_key_id<span style="color: #333333">=</span>ACCESS_KEY_ID,
        aws_secret_access_key<span style="color: #333333">=</span>ACCESS_SECRET_KEY,
    )
    <span style="color: #008800; font-weight: bold">try</span>:
        s3<span style="color: #333333">.</span>Bucket(BUCKET_NAME)<span style="color: #333333">.</span>put_object(Key<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;test_folder/&quot;</span> <span style="color: #333333">+</span> s3_filename2, Body<span style="color: #333333">=</span>data2)
        logging<span style="color: #333333">.</span>info(<span style="background-color: #fff0f0">&quot;Successfully uploaded file {} to S3 bucket {}/{}.&quot;</span><span style="color: #333333">.</span>format(local_filename2, BUCKET_NAME, s3_filename2))
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">Exception</span> <span style="color: #008800; font-weight: bold">as</span> e:
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Error: could not upload file:&quot;</span> <span style="color: #333333">+</span> local_filename2 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; to s3:&quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(e))

    <span style="color: #008800; font-weight: bold">print</span> (<span style="background-color: #fff0f0">&quot;Upload Emotion Done: &quot;</span> <span style="color: #333333">+</span> image_str)

<span style="color: #888888">#################</span>
<span style="color: #888888">### Endpoints ###</span>
<span style="color: #888888">#################</span>

<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&quot;/&quot;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">hello</span>():
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;&lt;h1 style=&#39;color:blue&#39;&gt;Welcome to raspi-smart-camera!&lt;/h1&gt;&lt;h2&gt;Endpoints:&lt;/h2&gt;&lt;h3&gt;classify, emotion, mask&lt;/h3&gt;&quot;</span>

<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/classify/&lt;input_str&gt;&#39;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">classify_image</span>(input_str):
    <span style="color: #888888"># don&#39;t put .jpg in the name, i&#39;ll add it myself</span>
    download(input_str) <span style="color: #888888"># downloads the original image from the upload folder in the bucket</span>
    classify(input_str) <span style="color: #888888"># run the image through both models and save them</span>
    upload(input_str) <span style="color: #888888"># upload the completed images into the processed folder _emotion.jpg and _mask.jpg</span>
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;classified and uploaded image: &quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(input_str)

<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/download/&lt;input_str&gt;&#39;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">download_image</span>(input_str):
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;downloading image: &quot;</span> <span style="color: #333333">+</span> input_str)
    test_download(input_str)
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;tried to download image: &quot;</span> <span style="color: #333333">+</span> <span style="color: #007020">str</span>(input_str)

<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/emotion/&lt;input_str&gt;&#39;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">emotion</span>(input_str):
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;GET Request for /emotion on image: &quot;</span> <span style="color: #333333">+</span> input_str)
    download(input_str)
    run_emotion_model(input_str)
    upload_emotion(input_str)
    <span style="color: #008800; font-weight: bold">return</span> (<span style="background-color: #fff0f0">&quot;Finished Executing Emotion&quot;</span>)

<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/mask/&lt;input_str&gt;&#39;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">mask</span>(input_str):
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;GET Request for /mask on image: &quot;</span> <span style="color: #333333">+</span> input_str)
    download(input_str)
    run_mask_model(input_str)
    upload_mask(input_str)
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;Finished Executing Mask&quot;</span>

<span style="color: #008800; font-weight: bold">if</span> __name__ <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;__main__&#39;</span>:
    app<span style="color: #333333">.</span>run(host<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;0.0.0.0&#39;</span>)
</pre>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <!-- Call To Action Area End -->

    <!-- Footer Area Start -->
    <footer class="footer-area section-padding-80-0">

        <!-- Main Footer Area -->

        <!-- Bottom Footer Area -->
        <div class="bottom-footer-area bg-gray">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-12 col-md-6">
                        <!-- Copywrite Text -->
                        <div class="copywrite-text">
                            <p>
                                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                                Copyright &copy;
                                <script>document.write(new Date().getFullYear());</script> All rights reserved | This
                                template is made with <i class="fa fa-heart-o" aria-hidden="true"></i> by <a
                                    href="https://colorlib.com" target="_blank">Colorlib</a>
                                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Area End -->

    <!-- **** All JS Files ***** -->
    <!-- jQuery 2.2.4 -->
    <script src="js/jquery.min.js"></script>
    <!-- Popper -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap -->
    <script src="js/bootstrap.min.js"></script>
    <!-- All Plugins -->
    <script src="js/hami.bundle.js"></script>
    <!-- Active -->
    <script src="js/default-assets/active.js"></script>

</body>

</html>